# デバイス識別仕様書（統合版）

## ⚠️ 重要: デバイス識別前に必ずこのファイルを参照してください

このファイルは、デバイスタイプ検出アルゴリズムの完全な仕様を定義しています。
デバイス識別処理を実装・修正する際は、必ずこの仕様に従ってください。

---

## 1. デバイスタイプの特徴と判定フロー

### 視覚的判定の優先順位（必須）

```
デバイスを見る
    ↓
【第1優先】キーボード/水平な板はあるか？
    ├─ YES → ✅ ラップトップ（確定）
    └─ NO
        ↓
【第2優先】黒い切り抜き/ノッチ/ダイナミックアイランドはあるか？
    ├─ YES → ✅ スマートフォン（確定）
    └─ NO
        ↓
【第3優先】アスペクト比で判定
    ├─ 0.4 - 0.7 → スマートフォン（可能性）
    ├─ 0.7 - 1.3 → タブレット（可能性）
    └─ 1.3 - 2.0 → ラップトップ（可能性）
```

### 1.1 ラップトップ (Laptop)

**必須識別特徴（最優先）:**
- ✅ **下部にキーボードまたは水平な板が必ず存在**（黒い横縞パターン）
- この特徴があれば、アスペクト比に関わらずラップトップと確定

**補助的特徴:**
- 大きな長方形のスクリーン
- 横長のアスペクト比（通常 16:9 = 1.78、16:10 = 1.6）
- ノッチや切り抜きなし
- ベゼルは通常均一な太さ

**縦方向:**
- 矢印は常に上向き（↑）
- スクリーンは垂直方向が「縦」

**検出パラメータ:**
```typescript
// キーボード検出
- スキャン領域: マスク画像の下部20%
- 幅: 中央80%
- 黒ピクセル閾値: 輝度 < 50
- 判定基準: 黒ピクセル率 >= 40%（水平縞パターン考慮）
- 信頼度ブースト: +30%
```

### 1.2 スマートフォン (Smartphone)

**必須識別特徴（最優先）:**
- ✅ **上部に黒い切り抜き（ノッチ）または黒い楕円（ダイナミックアイランド）**
- この特徴があれば、アスペクト比に関わらずスマートフォンと確定

**補助的特徴:**
- 細長い長方形のスクリーン
- 縦長のアスペクト比（通常 9:16 = 0.56、9:19.5 = 0.46）
- ベゼルは非常に薄い
- 角が丸い

**縦方向:**
- 縦向きの場合：矢印は上向き（↑）
- 横向きの場合：矢印は横向き（→）

**検出パラメータ:**
```typescript
// ノッチ検出
- スキャン領域: マスク画像の上部15%
- 幅: 中央70%
- 黒ピクセル閾値: 輝度 < 30
- 判定基準: 黒ピクセル率 >= 3%
- 信頼度ブースト: +30%
```

### 1.3 タブレット (Tablet)

**識別特徴:**
- ❌ **キーボードや水平な板がない**
- ❌ **ノッチや切り抜きなし**
- 大きな長方形のスクリーン
- 正方形に近いアスペクト比（3:4 = 0.75、4:3 = 1.33）
- ベゼルは均一で比較的太い

**縦方向:**
- 縦向きの場合：矢印は上向き（↑）
- 横向きの場合：矢印は斜め上向き（↗）

---

## 2. デバイス番号の割り当て（重要）

検出されたデバイスは、**画面領域の面積が大きい順**に番号が割り当てられます：

1. **デバイス1**: 最も大きな面積を持つデバイス
   - 通常はラップトップ
   - 左側や中央に配置されることが多い

2. **デバイス2**: 2番目に大きな面積を持つデバイス
   - 通常はスマートフォンまたはタブレット
   - 右側や下に配置されることが多い

3. **デバイス3**: 3番目に大きな面積を持つデバイス
   - 複数デバイス配置時のサブデバイス

### ⚠️ 重要な注意点

**デバイス番号 ≠ デバイスタイプ**

- デバイス1が必ずしもラップトップとは限らない
- デバイス2が必ずしもスマートフォンとは限らない
- 面積の大きさだけで番号が決まる
- 各デバイスのタイプは、視覚的特徴（キーボード、ノッチ）で独立して判定される

**例:**
```
画像内の配置:
┌─────────────┐  ┌──┐
│             │  │  │  ← 小さいラップトップ（デバイス2と判定される可能性）
│  スマホ      │  └──┘
│  (大きい)   │
└─────────────┘
    ↑
デバイス1と判定される可能性

正しい判定:
- デバイス1: スマートフォン（ノッチ検出）
- デバイス2: ラップトップ（キーボード検出）
```

---

## 3. アスペクト比による補助判定

| デバイスタイプ | アスペクト比範囲 | 典型的な値 |
|--------------|-----------------|-----------|
| ラップトップ | 1.3 - 2.0 | 16/9 (1.78), 16/10 (1.6) |
| タブレット | 0.7 - 1.3 | 4/3 (1.33), 3/4 (0.75) |
| スマートフォン | 0.4 - 0.7 | 9/16 (0.56), 9/19.5 (0.46) |

### アスペクト比スコアリング

```typescript
// ラップトップスコア
if (aspectRatio > 1.5) score += 70;
else if (aspectRatio > 1.35) score += 50;

// スマートフォンスコア
if (aspectRatio < 0.7) score += 50;
else if (aspectRatio < 0.85) score += 35;

// タブレットスコア
if (aspectRatio >= 0.7 && aspectRatio <= 1.35) score += 40;
```

---

## 4. 画像の向きと回転ロジック

### 4.1 ラップトップ
- 基本: 横長（回転なし、0度）
- 画像が縦長の場合: +90°回転

### 4.2 スマートフォン
- 基本: 縦長（回転なし、0度）
- 画像が横長でデバイスが縦長の場合: -90°回転（反時計回り）

### 4.3 タブレット
- 画像とデバイスの向きが一致しない場合に回転
- 画像が横長 & デバイスが縦長: -90°回転
- 画像が縦長 & デバイスが横長: +90°回転

---

## 5. 実装上の必須ルール

### 5.1 視覚的特徴を最優先（絶対ルール）

```typescript
// ❌ 間違った実装（アスペクト比だけで判定）
if (aspectRatio > 1.3) return 'laptop';

// ✅ 正しい実装（視覚的特徴を優先）
if (hasKeyboard) return 'laptop';  // キーボードがあれば確定
if (hasNotch) return 'smartphone'; // ノッチがあれば確定
// ここまで来たらアスペクト比で補助判定
```

### 5.2 ノッチ検出の精度向上

- スマートフォンのノッチは小さい
- 上部中央の狭い領域（中央70%、上部15%）のみをチェック
- 誤検出を避けるため、閾値は慎重に設定（3%以上）

### 5.3 キーボード検出の強化

- ラップトップの下部領域（下部20%）をスキャン
- 水平な黒い縞パターンを検出
- 閾値は40%以上（従来の30%から引き上げ）

### 5.4 信頼度計算

```typescript
let confidence = baseScore; // アスペクト比ベースのスコア

if (hasKeyboard && detectedType === 'laptop') {
  confidence += 30; // キーボード検出で信頼度ブースト
}

if (hasNotch && detectedType === 'smartphone') {
  confidence += 30; // ノッチ検出で信頼度ブースト
}

return Math.min(100, confidence);
```

---

## 6. デバッグログの出力フォーマット

### 6.1 デバイス検出結果

```typescript
🎯 Device type detection result: {
  type: 'laptop',
  confidence: '95.4%',
  hasNotch: false,
  hasKeyboard: true,
  aspectRatio: '1.67',
  visualFeatures: '⌨️ Keyboard detected'
}
```

### 6.2 キーボード検出

```typescript
⌨️ Keyboard detected (laptop feature): {
  blackRatio: 0.456,
  blackPixels: 3240,
  totalPixels: 7100,
  threshold: 0.40
}
```

### 6.3 ノッチ検出

```typescript
📱 Notch detected (smartphone feature): {
  blackRatio: 0.048,
  aspectRatio: 0.56,
  blackPixels: 156,
  totalPixels: 3250,
  threshold: 0.03
}
```

### 6.4 回転判定

```typescript
🔄 Orientation detection: {
  deviceType: 'smartphone',
  deviceAspectRatio: '0.56',
  imageAspectRatio: '1.78',
  rotationAngle: '-90°',
  explanation: 'Smartphone: Rotating landscape image -90° to portrait'
}
```

---

## 7. テストケースと期待される動作

### ケース1: ラップトップ + スマートフォン（一般的な構成）

**画像構成:**
- 左側: 横長の画面（ラップトップ）- 面積大
- 右側: 縦長の画面（スマートフォン）- 面積小

**期待される結果:**
```
デバイス1: laptop（面積が最大、キーボード検出）
  - 信頼度: 95%+
  - 視覚的特徴: ⌨️ Keyboard detected

デバイス2: smartphone（面積が2番目、ノッチ検出）
  - 信頼度: 90%+
  - 視覚的特徴: 📱 Notch detected
```

### ケース2: 大きなスマートフォン + 小さなラップトップ

**画像構成:**
- 中央: 大きな縦長画面（スマートフォン）- 面積大
- 右上: 小さな横長画面（ラップトップ）- 面積小

**期待される結果:**
```
デバイス1: smartphone（面積が最大、ノッチ検出）
  - 番号は1だが、タイプはスマートフォン
  - 視覚的特徴: 📱 Notch detected

デバイス2: laptop（面積が2番目、キーボード検出）
  - 番号は2だが、タイプはラップトップ
  - 視覚的特徴: ⌨️ Keyboard detected
```

---

## 8. 関連ファイルと実装箇所

### 8.1 主要ファイル

1. **このファイル（DEVICE_DETECTION_SPEC.md）**
   - デバイス識別の完全な仕様
   - 実装前に必ず参照すること

2. **src/features/mockup/utils/deviceTypeDetection.ts**
   - デバイス検出ロジックの実装
   - 以下の関数を含む:
     - `detectKeyboard()` - キーボード検出
     - `detectBlackCutout()` - ノッチ検出
     - `detectDeviceType()` - デバイスタイプ判定
     - `detectDeviceTypeFromRegion()` - 総合判定
     - `determineDeviceOrientation()` - 回転判定

3. **src/features/mockup/components/MultiDeviceMockup.tsx**
   - デバイス検出結果の利用
   - デバッグログの出力

### 8.2 実装時のチェックリスト

- [ ] DEVICE_DETECTION_SPEC.mdを確認した
- [ ] キーボード検出を最優先で実装した（40%閾値）
- [ ] ノッチ検出を第2優先で実装した（3%閾値）
- [ ] アスペクト比は補助的にのみ使用した
- [ ] デバイス番号とデバイスタイプを混同していない
- [ ] 信頼度計算に視覚的特徴のブーストを含めた
- [ ] 適切なデバッグログを出力している

---

## 9. よくある間違いと修正方法

### ❌ 間違い1: アスペクト比だけで判定

```typescript
// 間違い
if (aspectRatio > 1.3) {
  return 'laptop';
}
```

```typescript
// 正しい
if (hasKeyboard) {
  return 'laptop'; // キーボード検出が最優先
}
if (hasNotch) {
  return 'smartphone'; // ノッチ検出が第2優先
}
// アスペクト比は最後の手段
if (aspectRatio > 1.5) {
  return 'laptop';
}
```

### ❌ 間違い2: デバイス番号とタイプを混同

```typescript
// 間違い: デバイス1は常にラップトップと仮定
if (deviceIndex === 0) {
  deviceType = 'laptop';
}
```

```typescript
// 正しい: デバイス番号に関わらず視覚的特徴で判定
const deviceType = detectDeviceTypeFromRegion(
  maskData,
  region.rect
);
// deviceIndex と deviceType は独立
```

### ❌ 間違い3: キーボード検出の閾値が低すぎる

```typescript
// 間違い: 30%だとノイズを拾いやすい
if (blackRatio > 0.30) {
  return true; // キーボードあり
}
```

```typescript
// 正しい: 40%に引き上げて水平縞を確実に検出
if (blackRatio >= 0.40) {
  return true; // キーボードあり
}
```

---

## 10. 今後の改善計画

### 10.1 短期的改善
- [ ] 水平縞パターンのより高度な検出
- [ ] ノッチ形状（楕円、矩形）の区別
- [ ] タブレットとラップトップの境界ケース対応

### 10.2 中期的改善
- [ ] カメラホールの検出
- [ ] ベゼル太さの分析
- [ ] デバイスフレーム形状の認識

### 10.3 長期的改善
- [ ] 機械学習ベースの分類
- [ ] デバイスモデルの特定
- [ ] 3D配置の推定

---

## 11. まとめ

### デバイス識別の黄金律

1. **視覚的特徴を最優先**: キーボード → ノッチ → アスペクト比の順
2. **デバイス番号 ≠ デバイスタイプ**: 面積順の番号と視覚特徴による判定は別
3. **信頼度を活用**: 視覚的特徴検出時は信頼度を30%ブースト
4. **デバッグログを充実**: 判定過程を詳細に記録
5. **この仕様書を参照**: 実装前に必ずこのファイルを確認

### 実装時の心構え

> 「デバイスタイプは見た目で決まる。番号は大きさで決まる。この2つを混同しないこと。」

---

## 変更履歴

- 2025-12-04: DEVICE_DETECTION_IMPROVEMENTS.md と device.md を統合
- 改善: キーボード検出閾値を40%に引き上げ
- 改善: デバイス番号とデバイスタイプの区別を明確化
- 追加: よくある間違いセクション
