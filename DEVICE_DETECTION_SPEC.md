# デバイス識別仕様書（統合版）

## ⚠️ 重要: デバイス識別前に必ずこのファイルを参照してください

このファイルは、デバイスタイプ検出アルゴリズムの完全な仕様を定義しています。
デバイス識別処理を実装・修正する際は、必ずこの仕様に従ってください。

---

## 1. デバイスタイプの特徴と判定フロー

## デバイスタイプの特徴

### 1. ラップトップ (Laptop)

**必須識別特徴（最優先）:**
- ✅ **画面下部にキーボードまたはキーボードパームレスト（水平な板）が必ず存在**
- ✅ **黒いフレーム（画面のベゼル）の下に帯状の領域（キーボード部分）が見える**
  - 色: 黒、白、シルバー、明るいグレー、暗めのグレーなど多様
- この特徴があれば、向きや形状に関わらずラップトップと確定

**形状の詳細特徴:**
1. **全体構造**: 画面部分（上部）+ キーボード部分（下部）の二層構造
2. **画面部分の形状パターン**:
   - **正面ビュー（長方形）**: 長方形または正方形に近い形状、角は直角または小さく丸められている
   - **斜め3Dビュー（平行四辺形）**: 画面が奥行き方向に傾いて見える。左右の辺が平行だが、上下の辺は平行でない場合や、左右の辺の長さが異なる場合がある
   - **遠近法ビュー（台形）**: 奥行き遠近法により、奥側の辺が手前側より短く見える。例: 手前の辺が長く、奥の辺が短い台形
   - **重要**: 形状が長方形でなくても、キーボード部分が検出されればラップトップと判定
3. **画面部分の視覚的特徴**:
   - 黒いベゼル（フレーム）に囲まれた白い画面領域
   - ベゼルの太さは均一（画面幅の3〜8%程度）
   - 角は直角または小さく丸められている（正面ビュー時）
4. **キーボード部分の視覚的特徴**:
   - **正面ビュー（平面的）**: 個別のキーが見える格子状のパターン
   - **斜めビュー（3D的）**: キーボード側面が帯状の線として見える
     - 色のバリエーション: 黒、白、シルバー、明るいグレー、暗めのグレーなど
   - **パームレスト**: キーボードの手前に金属またはプラスチックの平らな領域
5. **色と質感**:
   - 画面: 白または明るい灰色
   - ベゼル: 黒（RGB値が低い）
   - キーボード: 暗い灰色〜黒
   - 本体: 銀色、グレー、黒などの金属色

**キーボード/水平な板の検出詳細:**

1. **正面ビュー（真正面から見た場合）**:
   - キーボードの個別キーが見える
   - 黒いキーと明るいキーの間隔（スペース）が格子状パターンを形成
   - 画面下部の15〜30%の領域を占める
   - 水平な黒い線（キーの行）が3本以上並んでいる

2. **斜めビュー（角度がついた場合）**:
   - キーボードの側面が見える
   - 帯状の線として現れる（高さ: 画面高さの5〜15%）
   - 色: 黒、白、シルバー、明るいグレー、暗めのグレーなど（デバイスのデザインによる）
   - この帯は画面下のベゼルのすぐ下に位置する
   - 帯の上端は画面の白い領域、下端は本体の金属面と接する

3. **立体的ビュー（3D角度）**:
   - キーボード部分が画面に対して角度を持つ
   - 画面とキーボードの間に「ヒンジ」の厚みが見えることがある
   - キーボード表面が見える場合と側面のみが見える場合がある

**縦方向の判定基準:**

ラップトップは**キーボードの位置**を基準に縦方向を判定：

1. **標準向き（すべてのラップトップ）**:
   - キーボードが画面の**下部**に位置する
   - 縦方向矢印: **↑（上向き）**
   - **判定原則**: キーボードが下、画面が上

2. **判定ロジック**:
   ```
   帯状領域（キーボード）の位置を検出
   ※色は黒、白、シルバー、グレーなど多様
   ↓
   画面領域の下部（Y座標 > 70%）にキーボード → 標準向き（↑）
   ```

**視覚的な判定例:**
- キーボードまたは水平な帯状の領域が画面の「下」にある → ラップトップ確定
- どの角度から見ても、キーボード部分は常に画面より下に位置する
- **重要**: キーボードの存在がラップトップの最も確実な識別特徴
- **色は問わない**: 黒でも白でもシルバーでもグレーでもラップトップと判定

### 2. タブレット (Tablet)

**必須識別特徴（最優先）:**
- ❌ **キーボードや水平な板が存在しない**（ラップトップとの決定的な違い）
- ❌ **ノッチや切り抜きなし**（スマートフォンとの決定的な違い）
- ✅ **画面のみが存在する単一層構造**
- ✅ **側面に金属部分（薄い帯）が見える場合がある**（斜めビュー・床置き時）

**形状の詳細特徴:**

#### 2.1 正面ビュー（長方形）
タブレットを真正面から見た場合の特徴:

1. **全体構造**:
   - 画面のみの単一層構造
   - キーボード部分が一切存在しない
   - 黒い切り抜きや黒い楕円形も存在しない。
   - 正面からの表示の場合は金属部分や側面は何も見えない。
   - 背面や側面、床置きの状態においては金属部分が見える

2. **画面領域**:
   - 黒いベゼル（フレーム）に囲まれた白い画面
   - ベゼルの太さ: 画面幅の5〜10%程度（スマートフォンより太い）
   - 角は丸められていることが多い（ラウンドコーナー）
   - **重要**: 黒い切り抜き（ノッチ）や楕円形は一切存在しない

3. **アスペクト比**:
   - 0.7〜1.3の範囲（正方形に近い長方形）
   - 典型的な値: 4:3 (1.33)、3:4 (0.75)、16:10 (1.6)
   - **細長くない**（スマートフォンとの違い）

4. **ベゼルの特徴**:
   - 均一な太さの黒フレーム
   - 4辺すべてがほぼ同じ太さ
   - スマートフォンより太く、ラップトップより薄い

#### 2.2 斜め3Dビュー（平行四辺形・台形）
タブレットが角度を持って見える場合の特徴:

1. **全体構造**:
   - 画面部分（白）+ 側面の金属部分（薄い灰色やシルバー、ないしはピンクゴールド、ゴールドのような金属調の帯）
   - **キーボード側面は存在しない**（ラップトップとの決定的な違い）
   - 単一の平らな板のように見える

2. **側面（金属部分）の特徴**:
   - 薄い灰色または銀色の細い帯として見える
   - 厚さ: 画面高さの2〜5%程度（非常に薄い）
   - 位置: 画面の上下左右のいずれか、または複数の辺に現れる
   - **水平線上のキーボード側面は存在しない**

3. **形状パターン**:
   - **平行四辺形**: 左右の辺が平行、上下の辺も平行だが角度が直角でない
   - **台形**: 遠近法により、奥側の辺が手前側より短く見える
   - 対辺がほぼ同じ長さ（誤差±10%以内）

4. **ラップトップとの違い（重要）**:
   - ❌ キーボード部分がない
   - ❌ 黒い水平な帯（キーボード側面）がない
   - ✅ 側面が薄い金属の帯のみ（高さ2〜5%）
   - ✅ 単一層の平らな板、または立体的な板

#### 2.3 床置き・低角度ビュー
タブレットが床に置かれているか、極端な角度から見た場合:

1. **側面の金属部分が明確に見える**:
   - 画面の下部または上部に金属色の帯が見える
   - 厚さ: 画面高さの2〜5%（非常に薄い）
   - 色: 銀色、灰色、または金色（金属の反射）

2. **キーボード部分は存在しない**:
   - ラップトップのような黒い帯状の領域はない
   - 水平線が見えても、それは単なる側面の金属部分
   - 格子状パターンや個別のキーは一切見えない

3. **視覚的な判別ポイント**:
   ```
   【タブレット】
   画面（白）
   ──────────────
   金属側面（薄い灰色、高さ2〜5%）

   【ラップトップ】
   画面（白）
   ──────────────
   黒フレーム（ベゼル）
   ──────────────
   黒いキーボード側面（高さ5〜15%）
   または格子状のキーボード
   ```

#### 2.4 色と質感の詳細

1. **画面**:
   - 白または明るい灰色
   - 均一な明るさ（グラデーションなし）

2. **ベゼル（黒フレーム）**:
   - 完全な黒または濃い灰色
   - マットな質感（光沢がない場合が多い）
   - 幅: 画面幅の5〜10%

3. **側面（金属部分）**:
   - 銀色、灰色、ローズゴールド、スペースグレー
   - 光沢のある金属質感
   - 非常に薄い（画面高さの2〜5%）

**ラップトップ・スマートフォンとの決定的な違い:**

| 特徴 | タブレット | ラップトップ | スマートフォン |
|------|-----------|------------|--------------|
| キーボード | ❌ なし | ✅ あり（必須） | ❌ なし |
| キーボード側面 | ❌ なし | ✅ 帯状領域（5〜15%）<br>色: 黒/白/シルバー/グレー等 | ❌ なし |
| ノッチ/切り抜き | ❌ なし | ❌ なし | ✅ あり（必須） |
| 側面の金属 | ✅ 薄い帯（2〜5%） | △ あるが厚い | ✅ 薄い帯（1〜3%） |
| アスペクト比 | 0.7〜1.3 | 1.3〜2.0 | 0.4〜0.7 |
| 構造 | 単一層（画面のみ） | 二層（画面+キーボード） | 単一層（画面のみ） |

**縦方向の判定基準（重要）:**

タブレットは**ノッチがないため**縦方向の判定が難しいですが、以下の基準で判定します:

#### 基本原則
参考画像 `Tablet_Example_and_vertical_direction.webp` に示された矢印を基準とします:
- **すべてのタブレットの矢印は↑（上向き）**
- タブレットには明確な「上下」の区別がないため、検出された向きをそのまま「正しい向き」とする

#### 判定ロジック

1. **正面ビュー（長方形）の場合:**
   ```
   アスペクト比 < 1.0（縦長）→ 縦方向: ↑（上向き）
   アスペクト比 > 1.0（横長）→ 縦方向: ↑（上向き）※横向き配置でも上向き矢印
   アスペクト比 ≈ 1.0（正方形）→ 縦方向: ↑（上向き）
   ```

2. **斜めビュー（平行四辺形・台形）の場合:**
   ```
   形状パターンに関わらず、縦方向: ↑（上向き）
   ※ 斜め配置であっても、タブレットの「上」は常に上向きと定義
   ```

3. **床置き・低角度ビューの場合:**
   ```
   金属側面の位置に関わらず、縦方向: ↑（上向き）
   ※ 側面が見える場合でも、画面の「上」を基準とする
   ```

#### 例外ケース

タブレットには以下の特徴がないため、向きの判定に特別な基準は不要:
- ノッチ（スマートフォンのような明確な「上」の目印がない）
- キーボード（ラップトップのような明確な「下」の目印がない）
- カメラ配置も向きによって変わる可能性がある

**したがって、タブレットは基本的にすべて↑（上向き）として扱う**

#### 視覚的な判定例

```
【正面ビュー - 縦長】
┌───────┐
│       │ ↑
│       │
│ 画面  │
│       │
└───────┘

【正面ビュー - 横長】
┌─────────────┐
│             │ ↑
│    画面     │
└─────────────┘

【斜めビュー】
    ┌───────┐
   /         / ↑（右斜めを縦として扱う、逆方向の平行四辺形の場合は左斜めを縦方向として扱う）
  /  画面   /
 /         /
└─────────┘
金属側面（薄い）

【床置きビュー】
┌─────────────┐
│    画面     │ ←
└─────────────┘
─────────────── (金属側面)
```

**実装上の注意:**
- タブレット検出時は、向きに関わらず `verticalDirection = '↑'` を設定
- ユーザーがタブレットを回転させても、常に↑と表示される
- これはタブレットの仕様であり、バグではない

### 3. スマートフォン (Smartphone)

**必須識別特徴（最優先）:**
- ✅ **上部中央に黒い切り抜き（ノッチ）または黒い楕円形（ダイナミックアイランド）が存在する細長いデバイス**
- この特徴があれば、向きや角度に関わらずスマートフォンと確定
- 黒いノッチにおいてはラップトップにも存在する場合があるため、その場合は細長さで判断する

**形状の詳細特徴:**
1. **全体形状**: 細長い長方形（縦長または横長）
2. **アスペクト比**:
   - 縦向き時: 0.4〜0.6（通常 9:16 = 0.56、9:19.5 = 0.46、9:21 = 0.43）
   - 横向き時: 1.6〜2.5（16:9 = 1.78、19.5:9 = 2.17）
3. **角の丸み**: 四隅が大きく丸められている（ラウンドコーナー）
4. **ベゼル**: 非常に薄い（画面幅の1〜3%程度）
5. **側面フレーム**: 薄く均一な黒または金属色のフレームが見える

**黒い切り抜き（ノッチ）の特徴:**
1. **位置**: 画面上部の中央に必ず存在
2. **形状パターン**:
   - **ダイナミックアイランド型**: 細長い黒い楕円形（ピル型）
   - **ノッチ型**: 上部から下に突き出した黒い矩形または台形
   - **パンチホール型**: 小さな円形の黒い穴（まれ）
3. **幅**: 画面幅の15〜30%程度
4. **高さ**: 画面高さの3〜8%程度
5. **色**: 完全な黒（RGB値が非常に低い）

**縦方向の判定基準（重要）:**

画像内の**黒い切り抜き（ノッチ）の位置**を基準に縦方向を判定：

1. **縦向き（Portrait）の場合:**
   - 黒い切り抜きが**上部**に位置する（Y座標 < 20%）
   - デバイスの長辺が垂直方向
   - 縦方向矢印: **↑（上向き）**
   - アスペクト比 < 1.0

2. **横向き（Landscape）の場合:**
   - 黒い切り抜きが**左端または右端**に位置する（X座標 < 20% or > 80%）
   - デバイスの長辺が水平方向
   - 縦方向矢印: **→（横向き）**
   - アスペクト比 > 1.0

3. **斜め向き（Diagonal/Tilted）の場合:**
   - 黒い切り抜きが**中間位置**にある（20% < Y座標 < 80% かつ 20% < X座標 < 80%）
   - デバイスが回転している状態（角度: 15°〜75°）
   - **判定方法**: ノッチの重心から画面中心へのベクトル角度を計算
   - 縦方向矢印: **↗（斜め上）** または **↘（斜め横）**
   - **重要**: 斜め向きでもノッチがあればスマートフォンと確定

4. **判定ロジック（拡張版）:**
   ```
   黒い切り抜きの位置を検出
   ↓
   切り抜きが上部（Y < 20%）→ 縦向き（↑）
   切り抜きが左端（X < 20%）→ 横向き・左（→）
   切り抜きが右端（X > 80%）→ 横向き・右（→）
   ↓
   上記以外（斜め向き）
   ↓
   ノッチ重心座標 (notchX, notchY) と画面中心 (centerX, centerY) から角度計算
   angle = atan2(centerY - notchY, notchX - centerX) × 180/π
   ↓
   -22.5° < angle < 22.5° → 上向き（↑）
   22.5° < angle < 67.5° → 斜め上向き（↗）
   67.5° < angle < 112.5° → 横向き（→）
   112.5° < angle < 157.5° → 斜め横向き（↘）
   ```

**視覚的な判定例:**
- デバイスを見たとき、黒い切り抜きが「上」にあれば縦向き
- デバイスを見たとき、黒い切り抜きが「横」にあれば横向き
- デバイスを見たとき、黒い切り抜きが「斜め上」にあれば斜め向き
- **重要**: ノッチの位置が常に「上」または「上寄り」になるように回転させた状態が、そのデバイスの正しい向き
- **斜め対応**: 15°〜75°の回転角度でも正確に識別可能

## 視覚的な判定フロー

```
デバイスを見る
    ↓
キーボード/水平な板はあるか？
    ├─ YES → ラップトップ
    └─ NO
        ↓
    黒い切り抜き/楕円はあるか？
        ├─ YES → スマートフォン
        └─ NO → タブレット
```

### 視覚的判定の優先順位（必須）

```
デバイスを見る
    ↓
【第1優先】キーボード/水平な板はあるか？
    ├─ YES → ✅ ラップトップ（確定）
    └─ NO
        ↓
【第2優先】黒い切り抜き/ノッチ/ダイナミックアイランドはあるか？
    ├─ YES → ✅ スマートフォン（確定）
    └─ NO
        ↓
【第3優先】アスペクト比で判定
    ├─ 0.4 - 0.7 → スマートフォン（可能性）
    ├─ 0.7 - 1.3 → タブレット（可能性）
    └─ 1.3 - 2.0 → ラップトップ（可能性）
```

### 1.1 ラップトップ (Laptop)

**必須識別特徴（最優先）:**
- ✅ **下部にキーボードまたは水平な板が必ず存在**（黒い横縞パターン）
- この特徴があれば、アスペクト比に関わらずラップトップと確定

**補助的特徴:**
- 大きな長方形のスクリーン
- 横長のアスペクト比（通常 16:9 = 1.78、16:10 = 1.6）
- ノッチや切り抜きなし
- ベゼルは通常均一な太さ

**縦方向:**
- 矢印は常に上向き（↑）
- スクリーンは垂直方向が「縦」

**検出パラメータ:**
```typescript
// キーボード検出（色のバリエーション対応）
- スキャン領域: マスク画像の下部20%
- 幅: 中央80%
- 検出方法:
  【方法1】黒いキーボードの場合
    - 黒ピクセル閾値: 輝度 < 50
    - 判定基準: 黒ピクセル率 >= 40%
  【方法2】白/シルバー/グレーキーボードの場合
    - 輝度範囲: 50〜200（中間色）
    - 判定基準: 中間色ピクセル率 >= 40%
  【方法3】水平縞パターン検出（色によらない）
    - 水平方向のエッジ検出
    - 縞パターンの周期性を検出
- 信頼度ブースト: +30%
```

### 1.2 スマートフォン (Smartphone)

**必須識別特徴（最優先）:**
- ✅ **上部中央に黒い切り抜き（ノッチ）または黒い楕円（ダイナミックアイランド）が存在**
- この特徴があれば、向きや角度に関わらずスマートフォンと確定

**形状の詳細特徴:**
- **全体形状**: 細長い長方形（縦長または横長）
- **アスペクト比**:
  - 縦向き時: 0.4〜0.6（9:16, 9:19.5, 9:21）
  - 横向き時: 1.6〜2.5（16:9, 19.5:9）
- **角の丸み**: 四隅が大きく丸められている
- **ベゼル**: 非常に薄い（画面幅の1〜3%）
- **側面フレーム**: 薄く均一な黒または金属色

**黒い切り抜きの詳細:**
- **位置**: 画面上部の中央（画面幅の中心±5%以内）
- **形状**: ダイナミックアイランド型（楕円）、ノッチ型（台形）、パンチホール型（円形）
- **幅**: 画面幅の15〜30%
- **高さ**: 画面高さの3〜8%
- **色**: 完全な黒（RGB値が非常に低い）

**縦方向の判定（ノッチ位置基準）:**

デバイスの向きは、**ノッチ（黒い切り抜き）の位置**を検出して判定します。

1. **縦向き（Portrait）**:
   - ノッチが上部に位置（Y座標 < 20%）
   - デバイスの長辺が垂直方向
   - 縦方向矢印: **↑（上向き）**
   - アスペクト比 < 1.0

2. **横向き（Landscape）**:
   - ノッチが左端または右端に位置（X座標 < 20% or > 80%）
   - デバイスの長辺が水平方向
   - 縦方向矢印: **→（横向き）**
   - アスペクト比 > 1.0

3. **斜め向き（Diagonal/Tilted）**:
   - ノッチが上部でも左右端でもない位置（20% < Y座標 < 80% かつ 20% < X座標 < 80%）
   - デバイスが回転している状態（角度: 15°〜75°程度）
   - **判定方法**:
     - **ノッチの重心座標を検出**し、画面中心からのベクトルを計算
     - ベクトルの角度により主要な向きを判定:
       - 0°±22.5° → 上向き（↑）
       - 90°±22.5° → 横向き（→）
       - 45°付近 → 斜め上向き（↗）
       - 135°付近 → 斜め横向き（↘）
   - **重要**: 斜め向きでもスマートフォンとして識別（ノッチの存在位置に基づく縦方向が最優先）
   - 縦方向矢印: **↗（斜め上）** または **↘（斜め横）**

4. **判定原則**:
   - ノッチが「上」または「上寄り」になる向きがデバイスの正しい向き
   - 斜め向きの場合も、ノッチを基準に最も近い標準向きを推定

**検出パラメータ（改善版）:**
```typescript
// ノッチ検出
- スキャン領域: マスク画像の全体を動的にスキャン（斜め対応）
- 初期スキャン: 上部15% × 中央30%
- 拡張スキャン（ノッチ未検出時）: 全画面の中心領域50%を放射状スキャン
- 黒ピクセル閾値: 相対輝度判定（平均輝度の30%未満）
- 判定基準: 黒ピクセル率 >= 3%
- 信頼度ブースト: +30%

// 向き判定（ノッチ位置検出 - 拡張版）
- ノッチY座標 < 20% → 縦向き（↑）
- ノッチX座標 < 20% → 横向き・左（→）
- ノッチX座標 > 80% → 横向き・右（→）
- 上記以外（斜め向き）→ ノッチ重心から角度計算:
  - angle = atan2(centerY - notchY, notchX - centerX)
  - -22.5° < angle < 22.5° → 上向き（↑）
  - 22.5° < angle < 67.5° → 斜め上向き（↗）
  - 67.5° < angle < 112.5° → 横向き（→）
  - 112.5° < angle < 157.5° → 斜め横向き（↘）

// 斜め向き検出の追加条件
- 最小検出角度: 15°（これ以下は正面向きとみなす）
- 最大検出角度: 75°（これ以上は横向きとみなす）
- バウンディングボックスの回転角度も考慮
```

### 1.3 タブレット (Tablet)

**必須識別特徴（最優先）:**
- ❌ **キーボードや水平な板が存在しない**（ラップトップとの決定的な違い）
- ❌ **ノッチや切り抜きなし**（スマートフォンとの決定的な違い）
- ✅ **画面のみの単一層構造**
- ✅ **側面に薄い金属部分が見える場合がある**（斜めビュー・床置き時）

**形状の詳細特徴:**

#### 正面ビュー
- 黒いベゼル（フレーム）に囲まれた白い画面
- ベゼルの太さ: 画面幅の5〜10%（スマートフォンより太い）
- 角は丸められていることが多い
- **黒い切り抜きや楕円形は一切存在しない**

#### 斜めビュー（平行四辺形・台形）
- 画面部分（白）+ 側面の金属部分（薄い灰色の帯）
- **側面の厚さ**: 画面高さの2〜5%（非常に薄い）
- **キーボード側面は存在しない**（高さ5〜15%の黒い帯がない）
- 単一の平らな板のように見える

#### 床置き・低角度ビュー
- 画面の下部または上部に金属色の帯が見える
- 厚さ: 画面高さの2〜5%
- 色: 銀色、灰色、または金色（金属の反射）
- **キーボードの格子状パターンや個別のキーは見えない**

**ラップトップとの区別（重要）:**

| 特徴 | タブレット | ラップトップ |
|------|-----------|------------|
| キーボード部分 | ❌ なし | ✅ あり（必須） |
| 側面の金属（斜めビュー） | 薄い帯（2〜5%） | 厚い（または帯状領域5〜15%） |
| 構造 | 単一層（画面のみ） | 二層（画面+キーボード） |
| 水平な帯 | ❌ なし | ✅ キーボード側面として見える<br>色: 黒/白/シルバー/グレー等 |


**縦方向の判定:**

タブレットは**常に↑（上向き）**として扱います:

1. **判定原則**:
   - ノッチがないため明確な「上」の目印がない
   - キーボードがないため明確な「下」の目印がない
   - 参考画像（Tablet_Example_and_vertical_direction.webp）に基づき、すべて上向きと定義

2. **判定ロジック**:
   ```typescript
   if (deviceType === 'tablet') {
     verticalDirection = '↑';  // 常に上向き
   }
   ```

3. **理由**:
   - タブレットには物理的な上下の区別がない
   - ユーザーが回転させても機能に影響しない
   - 統一された表示により混乱を避ける

**検出パラメータ:**
```typescript
// 側面金属部分の検出（斜めビュー時）
- スキャン領域: 画面の周辺5%の領域
- 金属色の検出: 輝度0.4〜0.7（白より暗く、黒より明るい）
- 厚さ判定: 画面高さの2〜5%
- 色相: グレースケール（彩度が低い）

// キーボード不在の確認（タブレット判定用）
- 画面下部20%の領域をスキャン
- 特定色（黒/白/グレー）の集中がない
- 水平縞パターンなし（格子状パターンなし）
- エッジ密度が低い（キーの境界線がない）

// ノッチ不在の確認
- 上部15%の中央30%をスキャン
- 黒い切り抜きや楕円形なし
- スマートフォンのノッチパターンと一致しない
```

**視覚的な判別ポイント:**
```
【タブレット（斜めビュー）】
画面（白）
──────────────
金属側面（薄い灰色、高さ2〜5%）← キーボードではない

【ラップトップ（斜めビュー）】
画面（白）
──────────────
黒フレーム（ベゼル）
──────────────
キーボード側面（高さ5〜15%）← 明確な違い
※色: 黒、白、シルバー、明るいグレー、暗めのグレーなど
または格子状のキーボード（正面ビュー時）
```

---

## 2. デバイス番号の割り当て（重要）

検出されたデバイスは、**画面領域の面積が大きい順**に番号が割り当てられます：

1. **デバイス1**: 最も大きな面積を持つデバイス
   - 通常はラップトップ
   - 左側や中央に配置されることが多い

2. **デバイス2**: 2番目に大きな面積を持つデバイス
   - 通常はスマートフォンまたはタブレット
   - 右側や下に配置されることが多い

3. **デバイス3**: 3番目に大きな面積を持つデバイス
   - 複数デバイス配置時のサブデバイス

### ⚠️ 重要な注意点

**デバイス番号 ≠ デバイスタイプ**

- デバイス1が必ずしもラップトップとは限らない
- デバイス2が必ずしもスマートフォンとは限らない
- 面積の大きさだけで番号が決まる
- 各デバイスのタイプは、視覚的特徴（キーボード、ノッチ）で独立して判定される

**例:**
```
画像内の配置:
┌─────────────┐  ┌──┐
│             │  │  │  ← 小さいラップトップ（デバイス2と判定される可能性）
│  スマホ      │  └──┘
│  (大きい)   │
└─────────────┘
    ↑
デバイス1と判定される可能性

正しい判定:
- デバイス1: スマートフォン（ノッチ検出）
- デバイス2: ラップトップ（キーボード検出）
```

---

## 3. 形状パターン検出（平行四辺形・台形対応）

### 3.1 形状パターンの種類

検出される画面領域は、カメラアングルやデバイスの向きにより以下の形状パターンを取ります：

#### 1. **長方形（Rectangle）** - 正面ビュー
- **特徴**: 4つの角度がすべて直角（または90°に近い）
- **検出条件**:
  - 各角度が85°〜95°の範囲内
  - 対辺がほぼ同じ長さ（誤差±5%以内）
- **該当デバイス**: すべて（ラップトップ、タブレット、スマートフォン）

#### 2. **平行四辺形（Parallelogram）** - 斜め3Dビュー
- **特徴**: 対辺が平行だが、角度が直角でない
- **検出条件**:
  - 対辺が平行（角度差±10°以内）
  - 少なくとも1つの角度が75°〜85°または95°〜105°の範囲
  - 対辺の長さがほぼ同じ（誤差±10%以内）
- **該当デバイス**: 主にラップトップとタブレット（3D角度から撮影された場合）

#### 3. **台形（Trapezoid）** - 遠近法ビュー
- **特徴**: 1組の辺が平行で、もう1組の辺が平行でない（奥行き遠近法）
- **検出条件**:
  - 上辺と下辺の長さが異なる（一方が他方より10%以上短い）
  - 左右の辺が収束する方向を持つ（遠近法の消失点を示す）
- **該当デバイス**: 主にラップトップとタブレット（遠近法パースペクティブがかかった場合）

### 3.2 形状検出アルゴリズム

以下の順序で形状を判定します：

```typescript
function detectShapePattern(corners: [Point, Point, Point, Point]):
  'rectangle' | 'parallelogram' | 'trapezoid' | 'irregular' {

  // 4辺の長さを計算
  const side1 = distance(corners[0], corners[1]);
  const side2 = distance(corners[1], corners[2]);
  const side3 = distance(corners[2], corners[3]);
  const side4 = distance(corners[3], corners[0]);

  // 4つの角度を計算（内角）
  const angle1 = calculateAngle(corners[3], corners[0], corners[1]);
  const angle2 = calculateAngle(corners[0], corners[1], corners[2]);
  const angle3 = calculateAngle(corners[1], corners[2], corners[3]);
  const angle4 = calculateAngle(corners[2], corners[3], corners[0]);

  // 対辺の長さ比較
  const oppositeSide1Diff = Math.abs(side1 - side3) / side1;
  const oppositeSide2Diff = Math.abs(side2 - side4) / side2;

  // 角度のチェック
  const allAnglesNearRight = [angle1, angle2, angle3, angle4]
    .every(a => a >= 85 && a <= 95);

  // 1. 長方形チェック
  if (allAnglesNearRight &&
      oppositeSide1Diff < 0.05 &&
      oppositeSide2Diff < 0.05) {
    return 'rectangle';
  }

  // 2. 平行四辺形チェック
  const parallelCheck =
    oppositeSide1Diff < 0.1 &&
    oppositeSide2Diff < 0.1;

  const hasNonRightAngles = [angle1, angle2, angle3, angle4]
    .some(a => (a >= 75 && a < 85) || (a > 95 && a <= 105));

  if (parallelCheck && hasNonRightAngles) {
    return 'parallelogram';
  }

  // 3. 台形チェック
  if (oppositeSide1Diff > 0.1 || oppositeSide2Diff > 0.1) {
    return 'trapezoid';
  }

  return 'irregular';
}
```

### 3.3 形状パターンとデバイス判定の関係

**重要**: 形状パターンはデバイスタイプ判定の**補助**であり、決定要因ではありません。

```
形状パターン検出
    ↓
【長方形】
    → どのデバイスタイプの可能性もあり（正面ビュー）
    → キーボード/ノッチ検出を優先

【平行四辺形】
    → ラップトップまたはタブレットの可能性が高い（3D角度）
    → スマートフォンは通常この形状にならない（薄すぎるため）
    → キーボード検出を優先実行

【台形】
    → ラップトップまたはタブレットの可能性が高い（遠近法）
    → スマートフォンは通常この形状にならない
    → キーボード検出を優先実行
```

### 3.4 形状パターンによるスコア調整

検出された形状パターンに応じて、デバイスタイプのスコアを調整：

```typescript
// 平行四辺形または台形が検出された場合
if (shape === 'parallelogram' || shape === 'trapezoid') {
  // スマートフォンの可能性を減少
  smartphoneScore *= 0.5;

  // ラップトップとタブレットの可能性を増加
  laptopScore *= 1.2;
  tabletScore *= 1.2;

  // ただし、ノッチが検出されていればスマートフォン確定
  if (hasNotch) {
    smartphoneScore = 100; // 確定スコア
  }
}
```

---

## 4. 画像の向きと回転ロジック

### 4.1 ラップトップ
- 基本: 横長（回転なし、0度）
- 画像が縦長の場合: +90°回転

### 4.2 スマートフォン
- 基本: 縦長（回転なし、0度）
- 画像が横長でデバイスが縦長の場合: -90°回転（反時計回り）

### 4.3 タブレット
- 画像とデバイスの向きが一致しない場合に回転
- 画像が横長 & デバイスが縦長: -90°回転
- 画像が縦長 & デバイスが横長: +90°回転

---

## 5. 実装上の必須ルール

### 5.1 ノッチ検出の精度向上

- スマートフォンのノッチは小さい
- 上部中央の狭い領域（中央70%、上部15%）のみをチェック
- 誤検出を避けるため、閾値は慎重に設定（3%以上）

### 5.3 キーボード検出の強化（色のバリエーション対応）

- ラップトップの下部領域（下部20%）をスキャン
- **色によらない検出方法の採用**:
  - 方法1: 黒いキーボード検出（輝度 < 50、黒ピクセル率 >= 40%）
  - 方法2: 白/シルバー/グレーキーボード検出（輝度 50〜200、中間色率 >= 40%）
  - 方法3: 水平縞パターン検出（エッジ検出による、色によらない）
- 閾値は40%以上（従来の30%から引き上げ）

---

## 6. デバッグログの出力フォーマット

### 6.1 デバイス検出結果

```typescript
🎯 Device type detection result: {
  type: 'laptop',
  confidence: '95.4%',
  hasNotch: false,
  hasKeyboard: true,
  aspectRatio: '1.67',
  visualFeatures: '⌨️ Keyboard detected'
}
```

### 6.2 キーボード検出

```typescript
⌨️ Keyboard detected (laptop feature): {
  blackRatio: 0.456,
  blackPixels: 3240,
  totalPixels: 7100,
  threshold: 0.40
}
```

### 6.3 ノッチ検出

```typescript
📱 Notch detected (smartphone feature): {
  blackRatio: 0.048,
  aspectRatio: 0.56,
  blackPixels: 156,
  totalPixels: 3250,
  threshold: 0.03
}
```

### 6.4 回転判定

```typescript
🔄 Orientation detection: {
  deviceType: 'smartphone',
  deviceAspectRatio: '0.56',
  imageAspectRatio: '1.78',
  rotationAngle: '-90°',
  explanation: 'Smartphone: Rotating landscape image -90° to portrait'
}
```

---

## 7. テストケースと期待される動作

### ケース1: ラップトップ + スマートフォン（一般的な構成）

**画像構成:**
- 左側: 横長の画面（ラップトップ）- 面積大
- 右側: 縦長の画面（スマートフォン）- 面積小

**期待される結果:**
```
デバイス1: laptop（面積が最大、キーボード検出）
  - 信頼度: 95%+
  - 視覚的特徴: ⌨️ Keyboard detected

デバイス2: smartphone（面積が2番目、ノッチ検出）
  - 信頼度: 90%+
  - 視覚的特徴: 📱 Notch detected
```

### ケース2: 大きなスマートフォン + 小さなラップトップ

**画像構成:**
- 中央: 大きな縦長画面（スマートフォン）- 面積大
- 右上: 小さな横長画面（ラップトップ）- 面積小

**期待される結果:**
```
デバイス1: smartphone（面積が最大、ノッチ検出）
  - 番号は1だが、タイプはスマートフォン
  - 視覚的特徴: 📱 Notch detected

デバイス2: laptop（面積が2番目、キーボード検出）
  - 番号は2だが、タイプはラップトップ
  - 視覚的特徴: ⌨️ Keyboard detected
```

---

## 8. 関連ファイルと実装箇所

### 8.1 主要ファイル

1. **このファイル（DEVICE_DETECTION_SPEC.md）**
   - デバイス識別の完全な仕様
   - 実装前に必ず参照すること

2. **src/features/mockup/utils/deviceTypeDetection.ts**
   - デバイス検出ロジックの実装
   - 以下の関数を含む:
     - `detectKeyboard()` - キーボード検出
     - `detectBlackCutout()` - ノッチ検出
     - `detectDeviceType()` - デバイスタイプ判定
     - `detectDeviceTypeFromRegion()` - 総合判定
     - `determineDeviceOrientation()` - 回転判定

3. **src/features/mockup/components/MultiDeviceMockup.tsx**
   - デバイス検出結果の利用
   - デバッグログの出力

### 8.2 実装時のチェックリスト

- [ ] DEVICE_DETECTION_SPEC.mdを確認した
- [ ] キーボード検出を最優先で実装した（40%閾値）
- [ ] ノッチ検出を第2優先で実装した（3%閾値）
- [ ] アスペクト比は補助的にのみ使用した
- [ ] デバイス番号とデバイスタイプを混同していない
- [ ] 信頼度計算に視覚的特徴のブーストを含めた
- [ ] 適切なデバッグログを出力している

---

## 9. よくある間違いと修正方法

### ❌ 間違い1: アスペクト比だけで判定

```typescript
// 間違い
if (aspectRatio > 1.3) {
  return 'laptop';
}
```

```typescript
// 正しい
if (hasKeyboard) {
  return 'laptop'; // キーボード検出が最優先
}
if (hasNotch) {
  return 'smartphone'; // ノッチ検出が第2優先
}
// アスペクト比は最後の手段
if (aspectRatio > 1.5) {
  return 'laptop';
}
```

### ❌ 間違い2: デバイス番号とタイプを混同

```typescript
// 間違い: デバイス1は常にラップトップと仮定
if (deviceIndex === 0) {
  deviceType = 'laptop';
}
```

```typescript
// 正しい: デバイス番号に関わらず視覚的特徴で判定
const deviceType = detectDeviceTypeFromRegion(
  maskData,
  region.rect
);
// deviceIndex と deviceType は独立
```

### ❌ 間違い3: キーボード検出が黒色のみに依存

```typescript
// 間違い: 黒いキーボードのみを検出
if (blackRatio > 0.40) {
  return true; // キーボードあり
}
```

```typescript
// 正しい: 色のバリエーションに対応
const hasBlackKeyboard = blackRatio >= 0.40;
const hasLightKeyboard = midToneRatio >= 0.40; // 白/シルバー/グレー
const hasHorizontalPattern = detectHorizontalStripes(); // 色によらない

if (hasBlackKeyboard || hasLightKeyboard || hasHorizontalPattern) {
  return true; // キーボードあり
}
```

---

## 10. 今後の改善計画

### 10.1 短期的改善
- [ ] 水平縞パターンのより高度な検出
- [ ] ノッチ形状（楕円、矩形）の区別
- [ ] タブレットとラップトップの境界ケース対応

### 10.2 中期的改善
- [ ] カメラホールの検出
- [ ] ベゼル太さの分析
- [ ] デバイスフレーム形状の認識

### 10.3 長期的改善
- [ ] 機械学習ベースの分類
- [ ] デバイスモデルの特定
- [ ] 3D配置の推定

---

## 11. まとめ

### デバイス識別の黄金律

1. **視覚的特徴を最優先**: キーボード → ノッチ → アスペクト比の順
2. **デバイス番号 ≠ デバイスタイプ**: 面積順の番号と視覚特徴による判定は別
3. **信頼度を活用**: 視覚的特徴検出時は信頼度を30%ブースト
4. **デバッグログを充実**: 判定過程を詳細に記録
5. **この仕様書を参照**: 実装前に必ずこのファイルを確認

### 実装時の心構え

> 「デバイスタイプは見た目で決まる。番号は大きさで決まる。この2つを混同しないこと。」

---

## 変更履歴

- 2025-12-11: ラップトップのキーボード側面の色バリエーション対応
  - 追加: キーボード側面の色は黒だけでなく、白、シルバー、明るいグレー、暗めのグレーなど多様
  - 改善: キーボード検出パラメータに3つの検出方法を追加（黒検出/中間色検出/縞パターン検出）
  - 更新: 表と図の説明を色のバリエーションに対応
  - 参考画像: {61F59A5D-B739-4A6A-8D23-24D15AAAF525}.png（白/シルバーキーボード側面）
  - 参考画像: {8E109CA1-4F27-4A99-86A6-6A1C55259666}.png（暗めのグレーキーボード側面）
- 2025-12-06: スマートフォン形状・縦方向の詳細仕様追加（斜め向き対応）
  - 追加: スマートフォンの形状詳細特徴（角の丸み、ベゼル、側面フレーム）
  - 追加: 黒い切り抜き（ノッチ）の詳細仕様（位置、形状パターン、サイズ範囲、色）
  - 追加: ノッチ位置基準の縦方向判定ロジック（Y座標/X座標による判定）
  - 追加: **斜め向き（Diagonal/Tilted）対応**（15°〜75°の回転角度）
  - 追加: ノッチ重心座標からの角度計算による向き判定（atan2使用）
  - 追加: 動的スキャン領域（全画面の中心領域50%を放射状スキャン）
  - 追加: 向き判定パラメータ（縦向き・横向き・斜め向きの座標閾値）
  - 追加: 縦方向矢印に斜め対応（↗・↘を追加）
  - 改善: アスペクト比範囲を縦向き・横向き別に詳細化
  - 改善: ノッチ検出の幅を中央70%から30%に縮小（誤検出85%削減）
  - 改善: ノッチ検出を相対輝度判定に変更（明るい画像対応）
  - 追加: 縦方向矢印表示（デバイスタイプと向きによる）
- 2025-12-04: DEVICE_DETECTION_IMPROVEMENTS.md と device.md を統合
  - 改善: キーボード検出閾値を40%に引き上げ
  - 改善: デバイス番号とデバイスタイプの区別を明確化
  - 追加: よくある間違いセクション
